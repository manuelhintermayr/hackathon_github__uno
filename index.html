<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>UNO Spiel – 2 Spieler</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="uno.css">
    <!-- CSS aus index.html entfernt, alles ist jetzt in uno.css -->
</head>

<body>
    <div id="app">
        <div v-if="showColorPicker" class="color-picker-overlay">
            <div class="color-picker-modal">
                <div>Wähle eine Farbe:</div>
                <button v-for="color in ['red','green','blue','yellow']" :key="color" :class="['card', color]" style="margin:10px;min-width:60px;min-height:90px;font-size:1.5em;" @click="chooseColor(color)"></button>
            </div>
        </div>
        <div class="uno-table-4" :style="showColorPicker ? 'filter:blur(2px);pointer-events:none;' : ''">
            <div class="uno-row top-row">
                <div class="player-label" :class="{active: getPlayerIndex(1)===currentPlayer}">
                    Spieler {{getPlayerIndex(1)+1}} <span v-if="getPlayerIndex(1)===currentPlayer">(am Zug)</span>
                    <span style="font-size:0.9em; color:#ffd600; margin-left:8px;">({{ hands[getPlayerIndex(1)].length }} Karten)</span>
                </div>
                <div class="hand hand-row" v-if="getPlayerIndex(1)===currentPlayer">
                    <div v-for="(card, idx) in hands[getPlayerIndex(1)]" :key="idx" :class="['card', card.color]" @click="playCard(idx)" style="cursor:pointer">{{ card.value }}</div>
                </div>
                <div class="hand hand-row" v-else>
                    <div v-for="card in hands[getPlayerIndex(1)]" class="card back"></div>
                </div>
            </div>
            <div class="uno-row middle-row">
                <div class="side-player">
                    <div class="player-label" :class="{active: getPlayerIndex(2)===currentPlayer}">
                        Spieler {{getPlayerIndex(2)+1}} <span v-if="getPlayerIndex(2)===currentPlayer">(am Zug)</span>
                        <span style="font-size:0.9em; color:#ffd600; margin-left:8px;">({{ hands[getPlayerIndex(2)].length }} Karten)</span>
                    </div>
                    <div class="hand hand-col" v-if="getPlayerIndex(2)===currentPlayer">
                        <div v-for="(card, idx) in hands[getPlayerIndex(2)]" :key="idx" :class="['card', card.color]" @click="playCard(idx)" style="cursor:pointer">{{ card.value }}</div>
                    </div>
                    <div class="hand hand-col" v-else>
                        <div v-for="card in hands[getPlayerIndex(2)]" class="card back"></div>
                    </div>
                </div>
                <div class="center-stacks">
                    <div class="stacks">
                        <div>
                            <div>Ablagestapel</div>
                            <div v-if="discardPile.length" :class="['card', discardPile[discardPile.length-1].color]">
                                {{ discardPile[discardPile.length-1].value }}
                            </div>
                            <div v-else class="card back">?</div>
                            <div v-if="currentColor" :class="['current-color-indicator', currentColor]" title="Aktuelle Farbe"></div>
                        </div>
                        <div>
                            <div>Nachziehstapel</div>
                            <div class="card back">UNO</div>
                        </div>
                    </div>
                    <div v-if="showNextPlayerMsg" class="next-player-msg">Spieler {{currentPlayer+1}} ist jetzt am Zug.</div>
                    <div v-if="winner !== null" style="margin-top:30px; font-size:2em; color:#ffd600;">Spieler {{winner+1}} hat gewonnen!</div>
                    <div v-if="errorMsg" style="color:#ff5252; font-weight:bold; margin-bottom:10px;">{{ errorMsg }}</div>
                </div>
                <div class="side-player">
                    <div class="player-label" :class="{active: getPlayerIndex(3)===currentPlayer}">
                        Spieler {{getPlayerIndex(3)+1}} <span v-if="getPlayerIndex(3)===currentPlayer">(am Zug)</span>
                        <span style="font-size:0.9em; color:#ffd600; margin-left:8px;">({{ hands[getPlayerIndex(3)].length }} Karten)</span>
                    </div>
                    <div class="hand hand-col" v-if="getPlayerIndex(3)===currentPlayer">
                        <div v-for="(card, idx) in hands[getPlayerIndex(3)]" :key="idx" :class="['card', card.color]" @click="playCard(idx)" style="cursor:pointer">{{ card.value }}</div>
                    </div>
                    <div class="hand hand-col" v-else>
                        <div v-for="card in hands[getPlayerIndex(3)]" class="card back"></div>
                    </div>
                </div>
            </div>
            <div class="uno-row bottom-row" v-if="!waitingForNextPlayer">
                <div class="player-label" :class="{active: getPlayerIndex(0)===currentPlayer}">
                    Spieler {{getPlayerIndex(0)+1}} <span v-if="getPlayerIndex(0)===currentPlayer">(am Zug)</span>
                    <span style="font-size:0.9em; color:#ffd600; margin-left:8px;">({{ hands[getPlayerIndex(0)].length }} Karten)</span>
                </div>
                <div class="action-row">
                    <button v-if="getPlayerIndex(0)===currentPlayer" @click="drawCard" :disabled="!canDraw">Karte ziehen</button>
                    <button v-if="getPlayerIndex(0)===currentPlayer && hasDrawn" @click="passen">Passen</button>
                    <button @click="confirmNewGame" style="margin-left:20px;">Neues Spiel</button>
                </div>
                <div class="hand hand-row" v-if="getPlayerIndex(0)===currentPlayer">
                    <div v-for="(card, idx) in hands[getPlayerIndex(0)]" :key="idx" :class="['card', card.color]" @click="playCard(idx)" style="cursor:pointer">{{ card.value }}</div>
                </div>
                <div class="hand hand-row" v-else>
                    <div v-for="card in hands[getPlayerIndex(0)]" class="card back"></div>
                </div>
            </div>
            <div v-if="waitingForNextPlayer" class="next-player-msg" style="z-index:1200;">
    Spieler {{currentPlayer+1}}: Bitte klicke auf "Zug starten" um deine Karten zu sehen.
    <br>
    <button @click="continueTurn()" style="margin-top:10px;">Zug starten</button>
</div>
        </div>
        <div id="lobby" style="text-align:center; margin-top:40px;">
  <div id="lobbyInfo">Lobby: ...</div>
  <button id="startBtn" style="display:none; margin-top:20px;">Spiel starten</button>
  <div style="margin-top:10px; color:#aaa;">Warte auf weitere Spieler...</div>
</div>
    </div>
    <script src="uno.js"></script>
    <script>
let ws;
let playerId = null;
let lobbySize = 0;
let isHost = false;
let gameStarted = false;

function connectWS() {
  ws = new WebSocket(location.origin.replace(/^http/, 'ws'));
  ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    if (msg.type === 'joined') {
      playerId = msg.playerId;
      lobbySize = msg.lobbySize;
      isHost = playerId === 0;
      document.getElementById('lobbyInfo').innerText = `Lobby: ${lobbySize} Spieler`;
      if (isHost) document.getElementById('startBtn').style.display = '';
    }
    if (msg.type === 'lobby') {
      lobbySize = msg.players;
      document.getElementById('lobbyInfo').innerText = `Lobby: ${lobbySize} Spieler`;
    }
    if (msg.type === 'start') {
      gameStarted = true;
      document.getElementById('lobby').style.display = 'none';
      // TODO: Spiel-UI initialisieren mit msg.gameState
    }
    if (msg.type === 'update') {
      // TODO: Spiel-UI aktualisieren mit msg.gameState
    }
    if (msg.type === 'error') {
      alert(msg.message);
    }
  };
}
window.onload = function() {
  if (!window.WebSocket) {
    alert('WebSocket wird nicht unterstützt!');
    return;
  }
  document.getElementById('startBtn').onclick = function() {
    ws.send(JSON.stringify({ type: 'start' }));
  };
  connectWS();
};
    </script>
</body>

</html>