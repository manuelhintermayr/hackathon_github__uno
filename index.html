<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>UNO Spiel – 2 Spieler</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="uno.css">
    <!-- CSS aus index.html entfernt, alles ist jetzt in uno.css -->
</head>

<body>
    <div id="app">
        <div v-if="lobbyActive" id="lobby" style="text-align:center; margin-top:40px;">
            <div id="lobbyInfo">Lobby: {{ lobbySize }} Spieler</div>
            <div v-if="isHost">
                <button @click="startGame" :disabled="lobbySize < 2">Spiel starten</button>
            </div>
            <div style="margin-top:10px; color:#aaa;">Warte auf weitere Spieler... (2-4 Spieler möglich)</div>
            <div v-if="lobbyError" style="color:#ff5252; font-weight:bold; margin-top:20px;">{{ lobbyError }}</div>
        </div>
        <div v-else-if="gameError" style="text-align:center; color:#ff5252; font-weight:bold; margin-top:40px;">{{ gameError }}</div>
        <div v-else class="uno-table-4" :style="showColorPicker ? 'filter:blur(2px);pointer-events:none;' : ''">
            <div class="uno-row top-row">
                <div class="player-label" :class="{active: getPlayerIndex(1)===currentPlayer}">
                    Spieler {{getPlayerIndex(1)+1}} <span v-if="getPlayerIndex(1)===currentPlayer">(am Zug)</span>
                    <span style="font-size:0.9em; color:#ffd600; margin-left:8px;">({{ hands[getPlayerIndex(1)].length }} Karten)</span>
                </div>
                <div class="hand hand-row" v-if="getPlayerIndex(1)===currentPlayer">
                    <div v-for="(card, idx) in hands[getPlayerIndex(1)]" :key="idx" :class="['card', card.color]" @click="playCard(idx)" style="cursor:pointer">{{ card.value }}</div>
                </div>
                <div class="hand hand-row" v-else>
                    <div v-for="card in hands[getPlayerIndex(1)]" class="card back"></div>
                </div>
            </div>
            <div class="uno-row middle-row">
                <div class="side-player">
                    <div class="player-label" :class="{active: getPlayerIndex(2)===currentPlayer}">
                        Spieler {{getPlayerIndex(2)+1}} <span v-if="getPlayerIndex(2)===currentPlayer">(am Zug)</span>
                        <span style="font-size:0.9em; color:#ffd600; margin-left:8px;">({{ hands[getPlayerIndex(2)].length }} Karten)</span>
                    </div>
                    <div class="hand hand-col" v-if="getPlayerIndex(2)===currentPlayer">
                        <div v-for="(card, idx) in hands[getPlayerIndex(2)]" :key="idx" :class="['card', card.color]" @click="playCard(idx)" style="cursor:pointer">{{ card.value }}</div>
                    </div>
                    <div class="hand hand-col" v-else>
                        <div v-for="card in hands[getPlayerIndex(2)]" class="card back"></div>
                    </div>
                </div>
                <div class="center-stacks">
                    <div class="stacks">
                        <div>
                            <div>Ablagestapel</div>
                            <div v-if="discardPile.length" :class="['card', discardPile[discardPile.length-1].color]">
                                {{ discardPile[discardPile.length-1].value }}
                            </div>
                            <div v-else class="card back">?</div>
                            <div v-if="currentColor" :class="['current-color-indicator', currentColor]" title="Aktuelle Farbe"></div>
                        </div>
                        <div>
                            <div>Nachziehstapel</div>
                            <div class="card back">UNO</div>
                        </div>
                    </div>
                    <div v-if="showNextPlayerMsg" class="next-player-msg">Spieler {{currentPlayer+1}} ist jetzt am Zug.</div>
                    <div v-if="winner !== null" style="margin-top:30px; font-size:2em; color:#ffd600;">Spieler {{winner+1}} hat gewonnen!</div>
                    <div v-if="errorMsg" style="color:#ff5252; font-weight:bold; margin-bottom:10px;">{{ errorMsg }}</div>
                </div>
                <div class="side-player">
                    <div class="player-label" :class="{active: getPlayerIndex(3)===currentPlayer}">
                        Spieler {{getPlayerIndex(3)+1}} <span v-if="getPlayerIndex(3)===currentPlayer">(am Zug)</span>
                        <span style="font-size:0.9em; color:#ffd600; margin-left:8px;">({{ hands[getPlayerIndex(3)].length }} Karten)</span>
                    </div>
                    <div class="hand hand-col" v-if="getPlayerIndex(3)===currentPlayer">
                        <div v-for="(card, idx) in hands[getPlayerIndex(3)]" :key="idx" :class="['card', card.color]" @click="playCard(idx)" style="cursor:pointer">{{ card.value }}</div>
                    </div>
                    <div class="hand hand-col" v-else>
                        <div v-for="card in hands[getPlayerIndex(3)]" class="card back"></div>
                    </div>
                </div>
            </div>
            <div class="uno-row bottom-row" v-if="!waitingForNextPlayer">
                <div class="player-label" :class="{active: getPlayerIndex(0)===currentPlayer}">
                    Spieler {{getPlayerIndex(0)+1}} <span v-if="getPlayerIndex(0)===currentPlayer">(am Zug)</span>
                    <span style="font-size:0.9em; color:#ffd600; margin-left:8px;">({{ hands[getPlayerIndex(0)].length }} Karten)</span>
                </div>
                <div class="action-row">
                    <button v-if="getPlayerIndex(0)===currentPlayer" @click="drawCard" :disabled="!canDraw">Karte ziehen</button>
                    <button v-if="getPlayerIndex(0)===currentPlayer && hasDrawn" @click="passen">Passen</button>
                    <button @click="confirmNewGame" style="margin-left:20px;">Neues Spiel</button>
                </div>
                <div class="hand hand-row" v-if="getPlayerIndex(0)===currentPlayer">
                    <div v-for="(card, idx) in hands[getPlayerIndex(0)]" :key="idx" :class="['card', card.color]" @click="playCard(idx)" style="cursor:pointer">{{ card.value }}</div>
                </div>
                <div class="hand hand-row" v-else>
                    <div v-for="card in hands[getPlayerIndex(0)]" class="card back"></div>
                </div>
            </div>
            <div v-if="waitingForNextPlayer" class="next-player-msg" style="z-index:1200;">
    Spieler {{currentPlayer+1}}: Bitte klicke auf "Zug starten" um deine Karten zu sehen.
    <br>
    <button @click="continueTurn()" style="margin-top:10px;">Zug starten</button>
</div>
        </div>
    </div>
    <script src="uno.js"></script>
    <script>
let ws;
const app = Vue.createApp({
    data() {
        return {
            lobbyActive: true,
            lobbySize: 0,
            isHost: false,
            lobbyError: '',
            gameError: '',
            playerId: null,
            gameState: null,
            showColorPicker: false,
            waitingForNextPlayer: false,
            hands: [[], [], [], []],
            discardPile: [],
            currentPlayer: 0,
            currentColor: null,
            winner: null,
            errorMsg: '',
            hasDrawn: false,
            canDraw: true,
            showNextPlayerMsg: false,
            // ...weitere UNO-States wie bisher...
        };
    },
    computed: {
        myHand() {
            if (!this.gameState || this.playerId === null) return [];
            return this.gameState.hands[this.playerId] || [];
        },
        hands() {
            // Zeigt für alle Spieler die Kartenanzahl, aber nur für sich selbst die echten Karten
            if (!this.gameState || this.playerId === null) return [[], [], [], []];
            return this.gameState.hands.map((hand, idx) => {
                if (idx === this.playerId) return hand;
                return Array(hand.length).fill({ color: 'back', value: '' });
            });
        },
        discardPile() {
            return this.gameState ? this.gameState.discardPile : [];
        },
        currentPlayer() {
            return this.gameState ? this.gameState.currentPlayer : 0;
        },
        currentColor() {
            return this.gameState ? this.gameState.currentColor : null;
        },
        winner() {
            return this.gameState ? this.gameState.winner : null;
        },
        canDraw() {
            // Optional: Logik, wann Ziehen erlaubt ist
            return this.gameState && this.currentPlayer === this.playerId && !this.hasDrawn;
        },
        hasDrawn() {
            return this.gameState && this.gameState.hasDrawn && this.currentPlayer === this.playerId;
        },
        showNextPlayerMsg() {
            return this.gameState && this.gameState.showNextPlayerMsg;
        }
    },
    methods: {
        startGame() {
            ws.send(JSON.stringify({ type: 'start' }));
        },
        playCard(idx) {
            if (this.currentPlayer !== this.playerId || this.showColorPicker) return;
            const card = this.myHand[idx];
            if (!card) return;
            if (card.color === 'wild' || card.color === 'wild4') {
                // Farbauswahl anzeigen
                this.showColorPicker = true;
                this.pendingCardIdx = idx;
            } else {
                ws.send(JSON.stringify({ type: 'play', idx }));
            }
        },
        drawCard() {
            if (this.currentPlayer !== this.playerId || this.hasDrawn) return;
            ws.send(JSON.stringify({ type: 'draw' }));
        },
        passen() {
            if (this.currentPlayer !== this.playerId || !this.hasDrawn) return;
            ws.send(JSON.stringify({ type: 'passen' }));
        },
        confirmNewGame() {
            ws.send(JSON.stringify({ type: 'newgame' }));
        },
        chooseColor(color) {
            if (!this.showColorPicker || this.pendingCardIdx === undefined) return;
            ws.send(JSON.stringify({ type: 'play', idx: this.pendingCardIdx, color }));
            this.showColorPicker = false;
            this.pendingCardIdx = undefined;
        },
        continueTurn() {
            this.waitingForNextPlayer = false;
        },
        getPlayerIndex(offset) {
            // Zeigt die Spieler im Uhrzeigersinn relativ zum eigenen Sitzplatz an
            if (this.playerId === null) return offset;
            if (!this.gameState || !this.gameState.hands) return offset;
            const n = this.gameState.hands.length;
            return (this.playerId + offset) % n;
        },
        handleWS(msg) {
            if (msg.type === 'joined') {
                this.playerId = msg.playerId;
                this.lobbySize = msg.lobbySize;
                this.isHost = this.playerId === 0;
                this.lobbyActive = true;
                this.lobbyError = '';
            }
            if (msg.type === 'lobby') {
                this.lobbySize = msg.players;
            }
            if (msg.type === 'start') {
                this.lobbyActive = false;
                this.gameState = msg.gameState;
                this.waitingForNextPlayer = false;
                this.gameError = '';
            }
            if (msg.type === 'update') {
                this.gameState = msg.gameState;
                this.waitingForNextPlayer = false;
            }
            if (msg.type === 'error') {
                this.lobbyError = msg.message;
                this.gameError = msg.message;
            }
        }
    },
    mounted() {
        ws = new WebSocket(location.origin.replace(/^http/, 'ws'));
        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            this.handleWS(msg);
        };
    }
});
app.mount('#app');
</script>
</body>

</html>